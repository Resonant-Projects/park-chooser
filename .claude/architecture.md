# Architecture & Data Flow

## Stack

| Layer         | Technology                                         |
| ------------- | -------------------------------------------------- |
| Frontend      | Astro (SSR + islands) with Starwind UI components  |
| Styling       | Tailwind CSS v4 (Vite plugin)                      |
| Backend       | Convex (real-time serverless functions + database) |
| Auth          | Clerk (OAuth, email, session management)           |
| Billing       | Clerk Billing (subscription management)            |
| External APIs | Google Places API (New), Distance Matrix API       |
| Hosting       | Vercel (frontend), Convex Cloud (backend)          |

## Core Data Flow

### Park Picking Flow

```
User clicks "Pick a Park"
    ↓
pickPark action (convex/actions/pickPark.ts)
    ↓
1. Verify authentication (ctx.auth.getUserIdentity)
2. Check daily pick limit (entitlements.checkCanPickToday)
3. Get user's park list (userParks.getUserParksWithDetails)
4. Get last 5 picks for this user
5. Filter out recently picked parks
6. Randomly select from eligible parks
7. Record pick + increment daily counter
8. Fetch fresh photos from Google (refs expire!)
    ↓
Return PickedPark to client
```

### User Signup Flow

```
User signs up via Clerk
    ↓
Clerk sends user.created webhook to /webhooks/clerk-billing
    ↓
users.upsertFromClerkWebhook creates user record
    ↓
User navigates to app, triggers seedUser action
    ↓
SRQ_PARKS (default parks) added to user's list
    ↓
Free entitlement created automatically
```

### Subscription Flow

```
User subscribes via Clerk Billing
    ↓
Clerk sends subscriptionItem.active webhook
    ↓
entitlements.upsertFromClerkWebhook updates tier to "premium"
    ↓
If user was referred:
    - processReferralConversion checks referral record
    - Grants referrer bonus days or discount code
```

## Business Rules

### Tier Limits (convex/lib/entitlements.ts)

| Tier    | Max Parks | Picks/Day |
| ------- | --------- | --------- |
| Free    | 5         | 1         |
| Premium | Unlimited | Unlimited |

### No-Repeat Constraint

- Each user's picks tracked in `picks` table with `userId`
- `getLastFivePickIdsForUser` returns recent park IDs
- `pickPark` filters these out before random selection
- Falls back to all parks if user has fewer than 5

### Referral System

- Users get a referral code (e.g., `KEITH-A7X2`)
- New signups can use code at registration
- When referee subscribes to premium:
  - Referrer gets 30 bonus premium days (if already subscribed)
  - Or a discount code (if on free tier)
- Fraud detection tracks IP/device fingerprints

## Key Files by Feature

### Authentication & Users

- `convex/users.ts` - User queries/mutations
- `convex/http.ts` - Clerk webhook handler
- `src/middleware.ts` - Route protection

### Entitlements & Billing

- `convex/entitlements.ts` - Tier checks, limit enforcement
- `convex/lib/entitlements.ts` - Tier definitions, error codes
- `convex/http.ts` - Billing webhook handler

### Park Selection

- `convex/actions/pickPark.ts` - Main selection logic
- `convex/userParks.ts` - User's park list management
- `convex/picks.ts` - Pick history

### Referrals

- `convex/referralCodes.ts` - Code generation/lookup
- `convex/actions/processReferralConversion.ts` - Reward processing
- `convex/lib/fraudDetection.ts` - Abuse prevention

## Environment Variables

### Required in Convex Dashboard

- `GOOGLE_MAPS_API_KEY` - Places API, Distance Matrix API
- `CLERK_BILLING_WEBHOOK_SECRET` - Svix signature verification

### Local Development (.env.local)

- `CONVEX_URL` - Auto-generated by `npx convex dev`
- `PUBLIC_CLERK_PUBLISHABLE_KEY` - Clerk frontend key
- `CLERK_SECRET_KEY` - Clerk backend key
