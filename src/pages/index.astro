---
import { getConvexUrl } from "../lib/convexClient";
import Analytics from "@vercel/analytics/astro";
import "../styles/global.css";

const convexUrl = getConvexUrl();
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Today's Park</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=Source+Sans+3:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <Analytics />
  </head>
  <body>
    <div class="container">
      <header>
        <h1 class="title">Today's Park</h1>
        <p class="subtitle">A random adventure awaits</p>
      </header>

      <main id="park-display">
        <div class="welcome-card">
          <div class="welcome-icon">üå≤</div>
          <h2 class="welcome-title">Ready for an adventure?</h2>
          <p class="welcome-text">Click below to discover your park for today!</p>
          <div class="bounce-arrow">‚Üì</div>
        </div>
      </main>

      <div class="actions">
        <button id="pick-again" class="pick-button">
          <span class="button-text">Pick a Park</span>
          <span class="button-spinner hidden"></span>
        </button>
      </div>

      <footer>
        <p>Parks are chosen randomly, with no repeats in the last 5 picks.</p>
        <p><a href="/stats" class="stats-link">View run stats ‚Üí</a></p>
      </footer>
    </div>

    <script define:vars={{ convexUrl }}>
      const button = document.getElementById("pick-again");
      const display = document.getElementById("park-display");

      async function pickNewPark() {
        button.disabled = true;
        button.querySelector(".button-text").textContent = "Finding park...";
        button.querySelector(".button-spinner").classList.remove("hidden");

        try {
          const response = await fetch(`${convexUrl}/api/action`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              path: "actions/pickPark:pickPark",
              args: {},
              format: "json",
            }),
          });

          const result = await response.json();

          if (result.status === "error") {
            throw new Error(result.errorMessage || "Failed to pick park");
          }

          const park = result.value;

          display.innerHTML = `
            <article class="park-card">
              ${
                park.photoUrl
                  ? `
                <div class="park-image-wrapper">
                  <img
                    src="${park.photoUrl}"
                    alt="Photo of ${park.name}"
                    class="park-image"
                    loading="eager"
                  />
                  <div class="image-overlay"></div>
                </div>
              `
                  : ""
              }
              <div class="park-info">
                ${park.customName ? `<p class="park-custom-name">${park.customName}</p>` : ""}
                <h2 class="park-name">${park.name}</h2>
                ${park.address ? `<p class="park-address">${park.address}</p>` : ""}
                <div class="travel-time-badge" data-place-id="${park.placeId}">
                  <span class="travel-time-spinner"></span>
                </div>
                <a
                  href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(park.name)}&query_place_id=${park.placeId}"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="maps-link"
                  data-park-id="${park._id}"
                >
                  Open in Google Maps ‚Üí
                </a>
              </div>
            </article>
          `;
        } catch (err) {
          display.innerHTML = `
            <div class="error-card">
              <div class="error-icon">‚ö†Ô∏è</div>
              <p class="error-message">${err.message}</p>
            </div>
          `;
        } finally {
          button.disabled = false;
          button.querySelector(".button-text").textContent = "Pick Another Park";
          button.querySelector(".button-spinner").classList.add("hidden");
        }
      }

      // Track visits when clicking "Open in Google Maps"
      // Uses fetch with keepalive for reliable fire-and-forget tracking that survives navigation
      function trackVisit(parkId) {
        fetch(`${convexUrl}/api/action`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            path: "actions/trackVisit:trackVisit",
            args: { parkId },
            format: "json",
          }),
          keepalive: true, // Ensures request completes even if page unloads
        }).catch(() => {}); // Silently ignore errors for fire-and-forget
      }

      // Geolocation and travel time calculation
      let userLocation = null;

      async function getUserLocation() {
        if (userLocation) return userLocation;

        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error("Geolocation not supported"));
            return;
          }

          navigator.geolocation.getCurrentPosition(
            (position) => {
              userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              resolve(userLocation);
            },
            (error) => {
              console.warn("Geolocation error:", error);
              reject(error);
            },
            {
              timeout: 10000,
              maximumAge: 300000, // Cache for 5 minutes
            }
          );
        });
      }

      async function updateTravelTime() {
        const badge = document.querySelector(".travel-time-badge");
        if (!badge) return;

        const placeId = badge.dataset.placeId;
        if (!placeId) return;

        try {
          const location = await getUserLocation();

          const response = await fetch(`${convexUrl}/api/action`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              path: "actions/getTravelTime:calculateTravelTime",
              args: {
                originLat: location.lat,
                originLng: location.lng,
                placeId: placeId,
              },
              format: "json",
            }),
          });

          const result = await response.json();

          if (result.status === "error" || !result.value) {
            throw new Error(result.errorMessage || "Failed to calculate travel time");
          }

          const travelData = result.value;

          badge.innerHTML = `
            <div class="travel-time-content">
              <span class="travel-duration">${travelData.durationText}</span>
              <span class="travel-distance">${travelData.distanceText}</span>
            </div>
          `;
          badge.classList.add("loaded");
        } catch (error) {
          console.warn("Could not get travel time:", error);
          badge.style.display = "none";
        }
      }

      // Attach click handlers to maps links
      function attachMapsLinkHandlers() {
        document.querySelectorAll(".maps-link").forEach((link) => {
          link.addEventListener("click", () => {
            const parkId = link.dataset.parkId;
            if (parkId) {
              trackVisit(parkId);
            }
          });
        });
      }

      // Attach handlers on initial load
      attachMapsLinkHandlers();

      // Re-attach after picking a new park
      const originalPickNewPark = pickNewPark;
      pickNewPark = async function () {
        await originalPickNewPark();
        attachMapsLinkHandlers();
        updateTravelTime();
      };

      button.addEventListener("click", pickNewPark);
    </script>
  </body>
</html>
