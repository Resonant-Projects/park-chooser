---
import { getConvexUrl } from "../lib/convexClient";
import Analytics from "@vercel/analytics/astro";
import "../styles/starwind.css";
import "../styles/global.css";
import Button from "../components/starwind/button/Button.astro";
import Card from "../components/starwind/card/Card.astro";
import CardContent from "../components/starwind/card/CardContent.astro";
import CardTitle from "../components/starwind/card/CardTitle.astro";
import CardDescription from "../components/starwind/card/CardDescription.astro";
import Spinner from "../components/starwind/spinner/Spinner.astro";

const convexUrl = getConvexUrl();
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Today's Park</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=Source+Sans+3:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <Analytics />
  </head>
  <body>
    <div class="container">
      <header>
        <h1 class="title">Today's Park</h1>
        <p class="subtitle">A random adventure awaits</p>
      </header>

      <main id="park-display">
        <Card class="bg-white/10 backdrop-blur-xl border border-white/15 text-center w-full">
          <CardContent class="py-12 px-8">
            <div class="text-5xl mb-4">üå≤</div>
            <CardTitle class="font-[Fraunces] text-2xl text-cream mb-3">
              Ready for an adventure?
            </CardTitle>
            <CardDescription class="text-mist mb-6">
              Click below to discover your park for today!
            </CardDescription>
            <div class="text-3xl text-gold animate-bounce">‚Üì</div>
          </CardContent>
        </Card>
      </main>

      <div class="actions">
        <Button
          id="pick-again"
          variant="primary"
          size="lg"
          class="rounded-full shadow-lg hover:shadow-xl transition-all hover:-translate-y-0.5"
        >
          <span class="button-text">Pick a Park</span>
          <Spinner class="button-spinner hidden size-4" />
        </Button>
      </div>

      <footer class="mt-8 text-center">
        <p class="text-sm text-mist opacity-80">Parks are chosen randomly, with no repeats in the last 5 picks.</p>
        <p class="text-sm text-mist opacity-80 mt-2"><a href="/stats" class="text-gold font-semibold hover:text-cream transition-colors">View run stats ‚Üí</a></p>
      </footer>
    </div>

    <script define:vars={{ convexUrl }}>
      const button = document.getElementById("pick-again");
      const display = document.getElementById("park-display");

      async function pickNewPark() {
        button.disabled = true;
        button.querySelector(".button-text").textContent = "Finding park...";
        button.querySelector(".button-spinner").classList.remove("hidden");

        try {
          const response = await fetch(`${convexUrl}/api/action`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              path: "actions/pickPark:pickPark",
              args: {},
              format: "json",
            }),
          });

          const result = await response.json();

          if (result.status === "error") {
            throw new Error(result.errorMessage || "Failed to pick park");
          }

          const park = result.value;

          display.innerHTML = `
            <article class="bg-cream rounded-3xl overflow-hidden shadow-2xl animate-card-appear w-full">
              ${
                park.photoUrl
                  ? `
                <div class="relative w-full aspect-[16/10] overflow-hidden">
                  <img
                    src="${park.photoUrl}"
                    alt="Photo of ${park.name}"
                    class="w-full h-full object-cover transition-transform duration-400 hover:scale-[1.03]"
                    loading="eager"
                  />
                  <div class="absolute inset-0 bg-gradient-to-b from-transparent via-transparent to-forest/15 pointer-events-none"></div>
                </div>
              `
                  : ""
              }
              <div class="relative p-7">
                ${park.customName ? `<p class="text-sm font-semibold text-sunset uppercase tracking-widest mb-1">${park.customName}</p>` : ""}
                <h2 class="font-[Fraunces] text-2xl font-semibold text-forest mb-2 leading-tight">${park.name}</h2>
                ${park.address ? `<p class="text-base text-moss mb-5 leading-relaxed">${park.address}</p>` : ""}
                <div class="travel-time-badge absolute bottom-7 right-7 bg-white/95 backdrop-blur-sm rounded-xl px-3 py-2 shadow-md flex items-center justify-center min-w-20 opacity-0 animate-badge-fade-in" data-place-id="${park.placeId}">
                  <span class="travel-time-spinner w-4 h-4 border-2 border-mist border-t-forest rounded-full animate-spin"></span>
                </div>
                <a
                  href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(park.name)}&query_place_id=${park.placeId}"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="maps-link inline-flex items-center gap-1 text-[0.9375rem] font-semibold text-sunset hover:text-bark transition-colors"
                  data-park-id="${park._id}"
                >
                  Open in Google Maps ‚Üí
                </a>
              </div>
            </article>
          `;
        } catch (err) {
          display.innerHTML = `
            <div class="bg-white/10 backdrop-blur-xl rounded-3xl p-10 text-center border border-white/15 w-full">
              <div class="text-4xl mb-4">‚ö†Ô∏è</div>
              <p class="text-lg text-cream font-medium">${err.message}</p>
            </div>
          `;
        } finally {
          button.disabled = false;
          button.querySelector(".button-text").textContent = "Pick Another Park";
          button.querySelector(".button-spinner").classList.add("hidden");
        }
      }

      // Track visits when clicking "Open in Google Maps"
      // Uses fetch with keepalive for reliable fire-and-forget tracking that survives navigation
      function trackVisit(parkId) {
        fetch(`${convexUrl}/api/action`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            path: "actions/trackVisit:trackVisit",
            args: { parkId },
            format: "json",
          }),
          keepalive: true, // Ensures request completes even if page unloads
        }).catch(() => {}); // Silently ignore errors for fire-and-forget
      }

      // Geolocation and travel time calculation
      let userLocation = null;

      async function getUserLocation() {
        if (userLocation) return userLocation;

        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error("Geolocation not supported"));
            return;
          }

          navigator.geolocation.getCurrentPosition(
            (position) => {
              userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              resolve(userLocation);
            },
            (error) => {
              console.warn("Geolocation error:", error);
              reject(error);
            },
            {
              timeout: 10000,
              maximumAge: 300000, // Cache for 5 minutes
            }
          );
        });
      }

      async function updateTravelTime() {
        const badge = document.querySelector(".travel-time-badge");
        if (!badge) return;

        const placeId = badge.dataset.placeId;
        if (!placeId) return;

        try {
          const location = await getUserLocation();

          const response = await fetch(`${convexUrl}/api/action`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              path: "actions/getTravelTime:calculateTravelTime",
              args: {
                originLat: location.lat,
                originLng: location.lng,
                placeId: placeId,
              },
              format: "json",
            }),
          });

          const result = await response.json();

          if (result.status === "error" || !result.value) {
            throw new Error(result.errorMessage || "Failed to calculate travel time");
          }

          const travelData = result.value;

          badge.innerHTML = `
            <div class="flex flex-col items-center gap-0.5">
              <span class="text-sm font-semibold text-forest whitespace-nowrap">${travelData.durationText}</span>
              <span class="text-[0.6875rem] text-sage whitespace-nowrap">${travelData.distanceText}</span>
            </div>
          `;
          badge.classList.add("loaded");
          badge.classList.remove("opacity-0");
        } catch (error) {
          console.warn("Could not get travel time:", error);
          badge.style.display = "none";
        }
      }

      // Attach click handlers to maps links
      function attachMapsLinkHandlers() {
        document.querySelectorAll(".maps-link").forEach((link) => {
          link.addEventListener("click", () => {
            const parkId = link.dataset.parkId;
            if (parkId) {
              trackVisit(parkId);
            }
          });
        });
      }

      // Attach handlers on initial load
      attachMapsLinkHandlers();

      // Re-attach after picking a new park
      const originalPickNewPark = pickNewPark;
      pickNewPark = async function () {
        await originalPickNewPark();
        attachMapsLinkHandlers();
        updateTravelTime();
      };

      button.addEventListener("click", pickNewPark);
    </script>
  </body>
</html>
