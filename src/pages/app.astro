---
import {
  getConvexUrl,
  getUserEntitlements,
  callAction,
  type UserEntitlements,
} from "../lib/convexClient";
import type { TodaysPickResult } from "../../convex/actions/getTodaysPick";
import { UserButton } from "@clerk/astro/components";
import Analytics from "@vercel/analytics/astro";
import SEO from "../components/SEO.astro";
import JsonLd from "../components/JsonLd.astro";
import { homepageSchema } from "../lib/schemas";
import { SITE_NAME, APP_SUBTITLE } from "../lib/config";
import "../styles/starwind.css";
import "../styles/global.css";
import Button from "../components/starwind/button/Button.astro";
import Card from "../components/starwind/card/Card.astro";
import CardContent from "../components/starwind/card/CardContent.astro";
import Spinner from "../components/starwind/spinner/Spinner.astro";

// Convex URL still needed for trackVisit (keepalive pattern)
const convexUrl = getConvexUrl();

// Get the Clerk token for Convex (SSR entitlements check)
const { getToken } = Astro.locals.auth();
const convexToken = await getToken({ template: "convex" });

// Fetch user entitlements for SSR display
let entitlements: UserEntitlements | null = null;
if (convexToken) {
  try {
    entitlements = await getUserEntitlements(convexToken);
  } catch (err) {
    console.error("Failed to fetch entitlements:", err);
  }
}

// Calculate limit status for display
const isFreeUser = entitlements?.tier === "free";
const canPick = entitlements?.canPick ?? true;

// Check if this is a first-time user (no parks in their list)
const isFirstTimeUser = convexToken && entitlements?.usage.currentParks === 0;

// Get referral code from cookie (for new user signups)
const referralCode = Astro.cookies.get("referral_code")?.value ?? null;

// Fetch today's pick if limit reached and user has picks today
let todaysPick: TodaysPickResult | null = null;
if (convexToken && !canPick && isFreeUser && entitlements?.usage.picksToday > 0) {
  try {
    todaysPick = await callAction<TodaysPickResult | null>(
      getConvexUrl(),
      "actions/getTodaysPick:getTodaysPick",
      {},
      convexToken
    );
  } catch (err) {
    console.error("Failed to fetch today's pick:", err);
  }
}
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#c9a227" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <SEO
      title={`${SITE_NAME} - ${APP_SUBTITLE}`}
      description={`End the 'which park?' debate! ${SITE_NAME} randomly picks your next family adventure from your curated list of local parks. Free to try.`}
    >
      <JsonLd schema={homepageSchema} />
    </SEO>
    <!-- Font preconnects -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <!-- API preconnects for faster park loading -->
    <link rel="preconnect" href="https://places.googleapis.com" crossorigin />
    <link rel="dns-prefetch" href="https://www.google.com" />
    <!-- Async font loading for faster initial render -->
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,600;9..144,700&family=Source+Sans+3:wght@500;600&display=swap"
      rel="stylesheet"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
      <link
        href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,600;9..144,700&family=Source+Sans+3:wght@500;600&display=swap"
        rel="stylesheet"
      />
    </noscript>
    <Analytics />
  </head>
  <body>
    <div class="container">
      <header>
        <div class="mb-2 flex items-start justify-between">
          <div>
            <h1 class="title">{SITE_NAME}</h1>
            <p class="subtitle">{APP_SUBTITLE}</p>
          </div>
          <div class="mt-1">
            <UserButton afterSignOutUrl="/sign-in">
              <UserButton.MenuItems>
                <UserButton.Link label="Manage Parks" href="/manage">
                  <svg
                    slot="label-icon"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                    width="16"
                    height="16"
                  >
                    <path d="M12 2L6 10h3v4H6l6 8 6-8h-3v-4h3L12 2z"></path>
                  </svg>
                </UserButton.Link>
              </UserButton.MenuItems>
            </UserButton>
          </div>
        </div>
      </header>

      <main id="park-display">
        {
          isFirstTimeUser ? (
            <Card
              id="onboarding-card"
              class="w-full border border-white/15 bg-white/10 text-center backdrop-blur-xl"
            >
              <CardContent class="px-8 py-12">
                <div class="mb-4 text-5xl">üéâ</div>
                <h2 class="text-cream mb-3 font-[Fraunces] text-2xl font-semibold">
                  Welcome to Your Random Park Picker!
                </h2>
                <p class="text-mist mb-6">
                  End the "which park?" debate. Add parks to your list and let us pick your next
                  family adventure.
                </p>
                <div class="flex flex-col items-center gap-4">
                  <Button
                    id="seed-recommended"
                    variant="primary"
                    size="lg"
                    class="text-forest rounded-full"
                  >
                    <span class="seed-text">Add Recommended Parks</span>
                    <Spinner class="seed-spinner hidden size-5" />
                  </Button>
                  <div class="text-mist text-sm">or</div>
                  <a
                    href="/manage"
                    class="text-gold hover:text-cream font-semibold transition-colors"
                  >
                    Browse park catalog ‚Üí
                  </a>
                </div>
              </CardContent>
            </Card>
          ) : !canPick && isFreeUser ? (
            todaysPick ? (
              <div class="w-full">
                <article class="bg-cream mb-6 w-full overflow-hidden rounded-3xl shadow-2xl">
                  {(todaysPick.photoUrls?.length || todaysPick.photoUrl) && (
                    <div class="carousel-container">
                      <div class="carousel-slides" data-carousel>
                        {(todaysPick.photoUrls || [todaysPick.photoUrl])
                          .filter(Boolean)
                          .map((url, i) => (
                            <div class="carousel-slide">
                              <img
                                src={url}
                                alt={`Photo ${i + 1} of ${todaysPick.name}`}
                                loading={i === 0 ? "eager" : "lazy"}
                                class="carousel-img"
                              />
                            </div>
                          ))}
                      </div>
                      {(todaysPick.photoUrls?.length || 0) > 1 && (
                        <div class="carousel-dots" data-carousel-dots>
                          {todaysPick.photoUrls?.map((_, i) => (
                            <button
                              class={`carousel-dot ${i === 0 ? "active" : ""}`}
                              data-index={i}
                              aria-label={`Go to photo ${i + 1}`}
                            />
                          ))}
                        </div>
                      )}
                    </div>
                  )}
                  <div class="relative p-7">
                    {todaysPick.customName && (
                      <p class="text-sunset mb-1 text-sm font-semibold tracking-widest uppercase">
                        {todaysPick.customName}
                      </p>
                    )}
                    <h2 class="text-forest mb-2 font-[Fraunces] text-2xl leading-tight font-semibold">
                      {todaysPick.name}
                    </h2>
                    {todaysPick.address && (
                      <p class="text-moss mb-5 text-base leading-relaxed">{todaysPick.address}</p>
                    )}
                    <div class="flex items-center justify-between">
                      <a
                        href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(todaysPick.name)}&query_place_id=${todaysPick.placeId}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="maps-link text-sunset hover:text-bark inline-flex items-center gap-1 text-[0.9375rem] font-semibold transition-colors"
                        data-park-id={todaysPick._id}
                      >
                        Open in Google Maps ‚Üí
                      </a>
                      <span class="text-mist text-sm">Today's Pick</span>
                    </div>
                  </div>
                </article>

                <div class="rounded-2xl border border-white/15 bg-white/10 p-6 text-center backdrop-blur-xl">
                  <p class="text-mist mb-4 text-sm">
                    Want to pick another park? Upgrade for unlimited daily picks.
                  </p>
                  <a
                    href="/pricing"
                    class="bg-gold text-forest hover:bg-cream inline-flex items-center gap-2 rounded-full px-5 py-3 font-semibold transition-colors"
                  >
                    <span>‚≠ê</span>
                    <span>Upgrade to Premium</span>
                  </a>
                </div>
              </div>
            ) : (
              <div class="w-full rounded-3xl border border-white/15 bg-white/10 p-10 text-center backdrop-blur-xl">
                <div class="mb-4 text-5xl">‚è∞</div>
                <h2 class="text-cream mb-3 font-[Fraunces] text-2xl font-semibold">
                  Daily Pick Limit Reached
                </h2>
                <p class="text-mist mb-6">
                  Free accounts get 1 random park pick per day. Come back tomorrow for a new
                  adventure!
                </p>
                <a
                  href="/pricing"
                  class="bg-gold text-forest hover:bg-cream inline-flex items-center gap-2 rounded-full px-5 py-3 font-semibold transition-colors"
                >
                  <span>‚≠ê</span>
                  <span>Upgrade for Unlimited Picks</span>
                </a>
              </div>
            )
          ) : (
            <Card class="w-full border border-white/15 bg-white/10 text-center backdrop-blur-xl">
              <CardContent class="px-8 py-12">
                <div class="mb-4 text-5xl">üå≤</div>
                <h2 class="text-cream mb-3 font-[Fraunces] text-2xl font-semibold">
                  Ready for a Park Adventure?
                </h2>
                <p class="text-mist mb-6">
                  Click below to randomly pick your next park destination!
                </p>
                <div class="text-gold animate-bounce text-3xl">‚Üì</div>
              </CardContent>
            </Card>
          )
        }
      </main>

      <div
        class="actions"
        id="pick-button-container"
        style={isFirstTimeUser ? "display: none;" : ""}
      >
        <Button
          id="pick-again"
          variant="primary"
          size="toddler"
          class="hover:shadow-3xl rounded-full shadow-2xl transition-all hover:-translate-y-1 active:scale-95 active:shadow-lg"
        >
          <span class="button-text">Pick a Park</span>
          <Spinner class="button-spinner hidden size-5" />
        </Button>
      </div>

      <footer class="mt-8 text-center">
        <p class="text-mist text-sm opacity-80">
          Parks are chosen randomly, with no repeats in the last 5 picks.
        </p>
        <p class="text-mist mt-2 text-sm opacity-80">
          <a href="/manage" class="text-gold hover:text-cream font-semibold transition-colors"
            >Manage parks</a
          >
          <span class="text-mist/50 mx-2">¬∑</span>
          <a href="/stats" class="text-gold hover:text-cream font-semibold transition-colors"
            >View stats</a
          >
        </p>
        <nav class="text-mist mt-4 flex justify-center gap-6 border-t border-white/10 pt-4 text-sm">
          <a href="/about" class="hover:text-cream transition-colors">About</a>
          <a href="/help" class="hover:text-cream transition-colors">Help</a>
          <a href="/legal/terms" class="hover:text-cream transition-colors">Terms</a>
          <a href="/legal/privacy" class="hover:text-cream transition-colors">Privacy</a>
        </nav>
      </footer>
    </div>

    <!-- Pass config to module script (convexUrl needed for trackVisit keepalive) -->
    <script
      define:vars={{
        convexUrl,
        canPick,
        isFreeUser,
        isFirstTimeUser,
        referralCode,
        hasTodaysPick: !!todaysPick,
      }}
    >
      window.__APP_CONFIG__ = {
        convexUrl,
        canPick,
        isFreeUser,
        isFirstTimeUser,
        referralCode,
        hasTodaysPick,
      };
    </script>

    <!-- Module script using Astro Actions -->
    <script>
      import { actions } from "astro:actions";
      import { getLocation, getLocationErrorMessage } from "../lib/geolocation";

      // Get config from SSR
      const { convexUrl, canPick, isFreeUser, isFirstTimeUser, referralCode, hasTodaysPick } =
        window.__APP_CONFIG__;

      // DOM elements
      const button = document.getElementById("pick-again");
      const display = document.getElementById("park-display");

      // ========== Error Helpers ==========

      function isLimitError(error) {
        if (!error) return false;
        const message = error.message || "";
        return (
          error.code === "FORBIDDEN" ||
          message.includes("DAILY_PICK_LIMIT_EXCEEDED") ||
          message.includes("Daily pick limit")
        );
      }

      function isNoParksError(error) {
        if (!error) return false;
        return error.code === "NOT_FOUND" || (error.message || "").includes("NO_PARKS");
      }

      function isAuthError(error) {
        if (!error) return false;
        return error.code === "UNAUTHORIZED";
      }

      // Create standardized error/info card
      function createInfoCard(emoji, title, message, actionHtml = "") {
        const card = document.createElement("div");
        card.className =
          "bg-white/10 backdrop-blur-xl rounded-3xl p-10 text-center border border-white/15 w-full";
        card.innerHTML = `
          <div class="text-5xl mb-4">${emoji}</div>
          <h2 class="font-[Fraunces] text-2xl text-cream mb-3">${title}</h2>
          <p class="text-mist mb-6">${message}</p>
          ${actionHtml}
        `;
        return card;
      }

      function showLimitReachedUI() {
        button.disabled = true;
        button.querySelector(".button-text").textContent = "Daily Limit Reached";
        button.querySelector(".button-spinner").classList.add("hidden");
        button.classList.add("opacity-60", "cursor-not-allowed");
      }

      // ========== Initial Setup ==========

      // Disable button if user has reached daily limit
      if (!canPick && isFreeUser) {
        button.disabled = true;
        // Show friendlier text when today's pick is displayed
        button.querySelector(".button-text").textContent = hasTodaysPick
          ? "Come Back Tomorrow"
          : "Daily Limit Reached";
        button.classList.add("opacity-60", "cursor-not-allowed");
      }

      // Store user on page load (with optional referral code)
      async function storeUser() {
        try {
          const args = referralCode ? { referralCode } : undefined;
          const { error } = await actions.storeUser(args);

          if (error) {
            console.error("Failed to store user:", error.message);
            return;
          }

          // Clear referral cookie after successful store
          if (referralCode) {
            fetch("/api/clear-referral-cookie", {
              method: "POST",
              credentials: "include",
              keepalive: true,
            }).catch(() => {});
          }
        } catch (err) {
          console.error("Failed to store user:", err);
        }
      }

      storeUser();

      // ========== First-Time User Seeding ==========

      const seedButton = document.getElementById("seed-recommended");
      if (seedButton && isFirstTimeUser) {
        seedButton.addEventListener("click", async () => {
          seedButton.disabled = true;
          seedButton.querySelector(".seed-text").textContent = "Adding parks...";
          seedButton.querySelector(".seed-spinner").classList.remove("hidden");

          const { error } = await actions.seedUserWithRecommendedParks();

          if (error) {
            console.error("Failed to seed parks:", error.message);
            seedButton.disabled = false;
            seedButton.querySelector(".seed-text").textContent = "Add Recommended Parks";
            seedButton.querySelector(".seed-spinner").classList.add("hidden");

            const existingError = seedButton.parentElement.querySelector(".text-red-400");
            if (existingError) existingError.remove();

            const errorDiv = document.createElement("p");
            errorDiv.className = "text-red-400 text-sm mt-3";
            errorDiv.textContent = "Failed to add parks. Please try again.";
            seedButton.parentElement.appendChild(errorDiv);
            return;
          }

          window.location.reload();
        });
      }

      // ========== Park Picking ==========

      let isPickingPark = false;

      async function pickNewPark() {
        // Debounce guard - prevent rapid clicks
        if (isPickingPark) {
          console.log("Pick request debounced");
          return;
        }

        isPickingPark = true;

        button.disabled = true;
        button.classList.add("button-loading");
        button.querySelector(".button-text").textContent = "Finding park...";
        button.querySelector(".button-spinner").classList.remove("hidden");

        try {
          const { data: park, error } = await actions.pickPark();

          if (error) {
            if (isLimitError(error)) {
              showLimitReachedUI();
              const limitCard = createInfoCard(
                "‚è∞",
                "Daily Limit Reached",
                "Free accounts get 1 park pick per day. Come back tomorrow for a new adventure!",
                `<a href="/pricing" class="inline-flex items-center gap-2 bg-gold text-forest font-semibold px-5 py-3 rounded-full hover:bg-cream transition-colors">
                  <span>‚≠ê</span>
                  <span>Upgrade for Unlimited Picks</span>
                </a>`
              );
              display.replaceChildren(limitCard);
              return;
            }
            if (isNoParksError(error)) {
              const noParksCard = createInfoCard(
                "üå≤",
                "No Parks Yet",
                "Add parks to your list to start picking!",
                `<a href="/manage" class="inline-flex items-center gap-2 bg-gold text-forest font-semibold px-5 py-3 rounded-full hover:bg-cream transition-colors">
                  <span>Add Parks</span>
                </a>`
              );
              display.replaceChildren(noParksCard);
              return;
            }
            if (isAuthError(error)) {
              console.warn("Authentication error, redirecting to sign-in:", error.message);
              window.location.href = "/sign-in";
              return;
            }
            throw new Error(error.message || "Failed to pick park");
          }

          // Build photo carousel HTML
          const photos = park.photoUrls || (park.photoUrl ? [park.photoUrl] : []);
          let carouselHtml = "";
          if (photos.length > 0) {
            const slidesHtml = photos
              .map(
                (url, i) => `
              <div class="carousel-slide">
                <img
                  src="${url}"
                  alt="Photo ${i + 1} of ${park.name}"
                  loading="${i === 0 ? "eager" : "lazy"}"
                  class="carousel-img"
                />
              </div>
            `
              )
              .join("");

            const dotsHtml =
              photos.length > 1
                ? `
              <div class="carousel-dots" data-carousel-dots>
                ${photos
                  .map(
                    (_, i) => `
                  <button
                    class="carousel-dot ${i === 0 ? "active" : ""}"
                    data-index="${i}"
                    aria-label="Go to photo ${i + 1}"
                  ></button>
                `
                  )
                  .join("")}
              </div>
            `
                : "";

            carouselHtml = `
              <div class="carousel-container">
                <div class="carousel-slides" data-carousel>
                  ${slidesHtml}
                </div>
                ${dotsHtml}
              </div>
            `;
          }

          display.innerHTML = `
            <article class="bg-cream rounded-3xl overflow-hidden shadow-2xl animate-card-appear w-full">
              ${carouselHtml}
              <div class="relative p-7">
                ${park.customName ? `<p class="text-sm font-semibold text-sunset uppercase tracking-widest mb-1">${park.customName}</p>` : ""}
                <h2 class="font-[Fraunces] text-2xl font-semibold text-forest mb-2 leading-tight">${park.name}</h2>
                ${park.address ? `<p class="text-base text-moss mb-5 leading-relaxed">${park.address}</p>` : ""}
                <div class="travel-time-badge absolute bottom-7 right-7 bg-white/95 backdrop-blur-sm rounded-xl px-3 py-2 shadow-md flex items-center justify-center min-w-20 opacity-0 animate-badge-fade-in" data-place-id="${park.placeId}">
                  <span class="travel-time-spinner w-4 h-4 border-2 border-mist border-t-forest rounded-full animate-spin"></span>
                </div>
                <a
                  href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(park.name)}&query_place_id=${park.placeId}"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="maps-link inline-flex items-center gap-1 text-[0.9375rem] font-semibold text-sunset hover:text-bark transition-colors"
                  data-park-id="${park._id}"
                >
                  Open in Google Maps ‚Üí
                </a>
              </div>
            </article>
          `;

          // Attach handlers, init carousel, and update travel time for the new card
          attachMapsLinkHandlers();
          initCarousels();
          initCarouselImageErrors();
          updateTravelTime(park.placeId);
        } catch (err) {
          console.error("Unexpected error picking park:", err);
          const errorCard = createInfoCard("‚ö†Ô∏è", "Something Went Wrong", "Please try again later.");
          display.replaceChildren(errorCard);
        } finally {
          isPickingPark = false;
          button.classList.remove("button-loading");
          button.querySelector(".button-spinner").classList.add("hidden");

          // Only re-enable if not at limit
          if (!button.classList.contains("cursor-not-allowed")) {
            button.disabled = false;
            button.querySelector(".button-text").textContent = "Pick Another Park";
          }
        }
      }

      // ========== Visit Tracking ==========

      // Uses keepalive for reliable fire-and-forget (stays as direct Convex call)
      function trackVisit(parkId) {
        fetch(`${convexUrl}/api/action`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            path: "actions/trackVisit:trackVisit",
            args: { parkId },
            format: "json",
          }),
          keepalive: true,
        }).catch(() => {});
      }

      function attachMapsLinkHandlers() {
        document.querySelectorAll(".maps-link").forEach((link) => {
          link.addEventListener("click", () => {
            const parkId = link.dataset.parkId;
            if (parkId) {
              trackVisit(parkId);
            }
          });
        });
      }

      // ========== Photo Carousel ==========

      function initCarousels() {
        document.querySelectorAll("[data-carousel]").forEach((carousel) => {
          const dots = carousel.parentElement.querySelector("[data-carousel-dots]");
          if (!dots) return;

          const dotButtons = dots.querySelectorAll(".carousel-dot");

          // Update dots on scroll
          carousel.addEventListener("scroll", () => {
            const scrollLeft = carousel.scrollLeft;
            const slideWidth = carousel.offsetWidth;
            const activeIndex = Math.round(scrollLeft / slideWidth);

            dotButtons.forEach((dot, i) => {
              dot.classList.toggle("active", i === activeIndex);
            });
          });

          // Click on dot to scroll
          dotButtons.forEach((dot) => {
            dot.addEventListener("click", () => {
              const index = parseInt(dot.dataset.index, 10);
              const slideWidth = carousel.offsetWidth;
              carousel.scrollTo({
                left: index * slideWidth,
                behavior: "smooth",
              });
            });
          });
        });
      }

      function initCarouselImageErrors() {
        document.querySelectorAll(".carousel-img").forEach((img) => {
          img.addEventListener(
            "error",
            function () {
              const parent = this.parentElement;
              if (!parent) return;
              const fallback = document.createElement("div");
              fallback.className = "photo-fallback";
              fallback.textContent = "üå≤";
              parent.innerHTML = "";
              parent.appendChild(fallback);
            },
            { once: true }
          );
        });
      }

      // Attach handlers on initial load
      attachMapsLinkHandlers();
      initCarousels();
      initCarouselImageErrors();

      // ========== Geolocation & Travel Time ==========

      async function updateTravelTime(placeId: string) {
        // Query badge by placeId to handle rapid picks correctly
        const badge = document.querySelector(
          `.travel-time-badge[data-place-id="${placeId}"]`
        ) as HTMLElement | null;
        if (!badge) return;

        const locationResult = await getLocation();

        if (!locationResult.success) {
          // Show meaningful error instead of hiding badge
          const errorMsg = getLocationErrorMessage(locationResult.error);
          badge.innerHTML = `
            <div class="flex items-center gap-1.5 text-mist" title="${errorMsg}">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <span class="text-xs">Location off</span>
            </div>
          `;
          badge.classList.remove("opacity-0");
          return;
        }

        try {
          const { data: travelData, error } = await actions.getTravelTime({
            originLat: locationResult.lat,
            originLng: locationResult.lng,
            placeId: placeId,
          });

          // Re-query badge in case user picked a different park during the API call
          const currentBadge = document.querySelector(
            `.travel-time-badge[data-place-id="${placeId}"]`
          ) as HTMLElement | null;
          if (!currentBadge) return; // Badge no longer exists (user picked different park)

          if (error || !travelData) {
            throw new Error(error?.message || "Failed to calculate travel time");
          }

          currentBadge.innerHTML = `
            <div class="flex flex-col items-center gap-0.5">
              <span class="text-sm font-semibold text-forest whitespace-nowrap">${travelData.durationText}</span>
              <span class="text-[0.6875rem] text-sage whitespace-nowrap">${travelData.distanceText}</span>
            </div>
          `;
          currentBadge.classList.add("loaded");
          currentBadge.classList.remove("opacity-0");
        } catch (error) {
          console.warn("Could not get travel time:", error);
          // Re-query badge
          const currentBadge = document.querySelector(
            `.travel-time-badge[data-place-id="${placeId}"]`
          ) as HTMLElement | null;
          if (currentBadge) {
            currentBadge.innerHTML = `
              <div class="flex items-center gap-1.5 text-mist" title="Unable to calculate">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="text-xs">--</span>
              </div>
            `;
            currentBadge.classList.remove("opacity-0");
          }
        }
      }

      // ========== Button Event Handlers ==========

      let lastTouchTime = 0;

      button.addEventListener("click", () => {
        // Skip if this click came from a touch event (within 300ms)
        if (Date.now() - lastTouchTime < 300) return;
        pickNewPark();
      });

      button.addEventListener(
        "touchstart",
        (e) => {
          e.preventDefault();
          lastTouchTime = Date.now();
          if (!isPickingPark) {
            pickNewPark();
          }
        },
        { passive: false }
      );
    </script>
  </body>
</html>
