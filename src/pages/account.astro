---
import {
  getUserEntitlements,
  getMyReferralCode,
  getMyReferralStats,
  type UserEntitlements,
  type MyReferralCode,
  type MyReferralStats,
} from "../lib/convexClient";
import { UserButton, UserProfile } from "@clerk/astro/components";
import "../styles/starwind.css";
import "../styles/global.css";
import Card from "../components/starwind/card/Card.astro";
import CardContent from "../components/starwind/card/CardContent.astro";
import Button from "../components/starwind/button/Button.astro";

// Auth check
const { userId, getToken } = Astro.locals.auth();
if (!userId) {
  return Astro.redirect("/sign-in");
}

const token = await getToken({ template: "convex" });
if (!token) {
  return Astro.redirect("/sign-in");
}

// Fetch entitlements and referral data in parallel
let entitlements: UserEntitlements | null = null;
let referralCode: MyReferralCode | null = null;
let referralStats: MyReferralStats | null = null;

try {
  [entitlements, referralCode, referralStats] = await Promise.all([
    getUserEntitlements(token),
    getMyReferralCode(token),
    getMyReferralStats(token),
  ]);
} catch (error) {
  console.error("Failed to fetch account data:", error);
}

// Build referral link
const siteUrl = import.meta.env.SITE_URL || "https://todayspark.app";
const referralLink = referralCode ? `${siteUrl}/r/${referralCode.code}` : null;

// Format period end date
const formatDate = (timestamp: number | undefined) => {
  if (!timestamp) return null;
  return new Date(timestamp).toLocaleDateString("en-US", {
    month: "long",
    day: "numeric",
    year: "numeric",
  });
};

const periodEndDate = formatDate(entitlements?.periodEnd);
const isPremium = entitlements?.tier === "premium";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Account - Today's Park</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=Source+Sans+3:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <div class="mb-2 flex items-start justify-between">
          <div>
            <a
              href="/"
              class="text-gold hover:text-cream mb-1 inline-block text-sm font-medium transition-colors"
              >&larr; Back</a
            >
            <h1 class="title">Account</h1>
            <p class="subtitle">Manage your account and subscription</p>
          </div>
          <div class="mt-1">
            <UserButton afterSignOutUrl="/sign-in">
              <UserButton.MenuItems>
                <UserButton.Link label="Manage Parks" href="/manage">
                  <svg
                    slot="label-icon"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                    width="16"
                    height="16"
                  >
                    <path d="M12 2L6 10h3v4H6l6 8 6-8h-3v-4h3L12 2z"></path>
                  </svg>
                </UserButton.Link>
              </UserButton.MenuItems>
            </UserButton>
          </div>
        </div>
      </header>

      <main class="space-y-6">
        <!-- Current Plan Card -->
        <Card class="border-white/15 bg-white/10 backdrop-blur-xl">
          <CardContent class="p-6">
            <div class="mb-4 flex items-center justify-between">
              <h2 class="text-cream font-[Fraunces] text-xl font-semibold">Your Plan</h2>
              {
                isPremium ? (
                  <span class="bg-gold/20 text-gold border-gold/30 inline-flex items-center gap-1.5 rounded-full border px-3 py-1 text-sm font-medium">
                    <span>‚≠ê</span>
                    <span>Premium</span>
                  </span>
                ) : (
                  <span class="bg-forest/20 text-cream border-forest/30 inline-flex items-center gap-1.5 rounded-full border px-3 py-1 text-sm font-medium">
                    <span>üå≤</span>
                    <span>Free</span>
                  </span>
                )
              }
            </div>

            {
              entitlements ? (
                <div class="space-y-4">
                  {/* Usage Stats */}
                  <div class="grid grid-cols-2 gap-4">
                    <div class="rounded-xl bg-white/5 p-4">
                      <p class="text-mist mb-1 text-sm">Parks Saved</p>
                      <p class="text-cream text-2xl font-semibold">
                        {entitlements.usage.currentParks}
                        {entitlements.limits.maxParks > 0 && (
                          <span class="text-mist text-base font-normal">
                            /{entitlements.limits.maxParks}
                          </span>
                        )}
                        {entitlements.limits.maxParks === -1 && (
                          <span class="text-gold ml-1 text-sm font-normal">unlimited</span>
                        )}
                      </p>
                    </div>
                    <div class="rounded-xl bg-white/5 p-4">
                      <p class="text-mist mb-1 text-sm">Picks Today</p>
                      <p class="text-cream text-2xl font-semibold">
                        {entitlements.usage.picksToday}
                        {entitlements.limits.picksPerDay > 0 && (
                          <span class="text-mist text-base font-normal">
                            /{entitlements.limits.picksPerDay}
                          </span>
                        )}
                        {entitlements.limits.picksPerDay === -1 && (
                          <span class="text-gold ml-1 text-sm font-normal">unlimited</span>
                        )}
                      </p>
                    </div>
                  </div>

                  {/* Plan Benefits */}
                  <div class="border-t border-white/10 pt-4">
                    <p class="text-mist mb-2 text-sm">Plan Benefits</p>
                    <ul class="space-y-2">
                      {isPremium ? (
                        <>
                          <li class="text-cream flex items-center gap-2 text-sm">
                            <span class="text-gold">‚úì</span> Unlimited parks
                          </li>
                          <li class="text-cream flex items-center gap-2 text-sm">
                            <span class="text-gold">‚úì</span> Unlimited daily picks
                          </li>
                          <li class="text-cream flex items-center gap-2 text-sm">
                            <span class="text-gold">‚úì</span> Priority support
                          </li>
                        </>
                      ) : (
                        <>
                          <li class="text-cream flex items-center gap-2 text-sm">
                            <span class="text-forest">‚úì</span> Save up to{" "}
                            {entitlements.limits.maxParks} parks
                          </li>
                          <li class="text-cream flex items-center gap-2 text-sm">
                            <span class="text-forest">‚úì</span> {entitlements.limits.picksPerDay}{" "}
                            park pick per day
                          </li>
                          <li class="text-mist/70 flex items-center gap-2 text-sm">
                            <span class="text-mist/50">-</span>{" "}
                            <span class="line-through">Unlimited parks</span>
                          </li>
                          <li class="text-mist/70 flex items-center gap-2 text-sm">
                            <span class="text-mist/50">-</span>{" "}
                            <span class="line-through">Unlimited daily picks</span>
                          </li>
                        </>
                      )}
                    </ul>
                  </div>

                  {/* Billing Info (Premium only) */}
                  {isPremium && periodEndDate && (
                    <div class="border-t border-white/10 pt-4">
                      <p class="text-mist text-sm">
                        {entitlements.status === "active"
                          ? `Your subscription renews on ${periodEndDate}`
                          : entitlements.status === "canceled"
                            ? `Your premium access ends on ${periodEndDate}`
                            : `Subscription status: ${entitlements.status}`}
                      </p>
                    </div>
                  )}

                  {/* Upgrade CTA (Free only) */}
                  {!isPremium && (
                    <div class="border-t border-white/10 pt-4">
                      <a
                        href="/pricing"
                        class="bg-gold text-forest hover:bg-cream inline-flex w-full items-center justify-center gap-2 rounded-full px-6 py-3 font-semibold transition-colors"
                      >
                        <span>‚≠ê</span>
                        <span>Upgrade to Premium</span>
                      </a>
                    </div>
                  )}
                </div>
              ) : (
                <p class="text-mist">Unable to load subscription information.</p>
              )
            }
          </CardContent>
        </Card>

        <!-- Referral Program Card -->
        <Card class="border-white/15 bg-white/10 backdrop-blur-xl">
          <CardContent class="p-6">
            <div class="mb-4 flex items-center justify-between">
              <h2 class="text-cream font-[Fraunces] text-xl font-semibold">Invite Friends</h2>
              {
                referralStats && referralStats.totalReferrals > 0 && (
                  <span class="bg-gold/20 text-gold border-gold/30 inline-flex items-center gap-1.5 rounded-full border px-3 py-1 text-sm font-medium">
                    {referralStats.totalReferrals} referral
                    {referralStats.totalReferrals !== 1 ? "s" : ""}
                  </span>
                )
              }
            </div>

            {
              referralLink ? (
                <div class="space-y-4">
                  {/* Referral Link Display */}
                  <div class="rounded-xl bg-white/5 p-4">
                    <p class="text-mist mb-2 text-sm">Your referral link</p>
                    <div class="flex items-center gap-2">
                      <code class="bg-forest/30 text-cream flex-1 truncate rounded-lg px-3 py-2 font-mono text-sm">
                        {referralLink}
                      </code>
                      <button
                        id="copy-link-btn"
                        class="bg-gold/20 hover:bg-gold/30 text-gold flex-shrink-0 rounded-lg px-3 py-2 transition-colors"
                        data-link={referralLink}
                      >
                        <span class="copy-text">Copy</span>
                        <span class="copied-text hidden">Copied!</span>
                      </button>
                    </div>
                  </div>

                  {/* Share Buttons */}
                  <div class="space-y-2">
                    <p class="text-mist text-sm">Share via</p>
                    <div class="flex flex-wrap gap-2">
                      {/* Native Share (mobile) */}
                      <button
                        id="native-share-btn"
                        class="bg-gold text-forest hover:bg-cream hidden rounded-full px-4 py-2 text-sm font-medium transition-colors"
                        data-link={referralLink}
                        data-title="Join me on Today's Park!"
                        data-text="Discover your next park adventure with Today's Park!"
                      >
                        Share
                      </button>

                      {/* SMS */}
                      <a
                        href={`sms:?body=${encodeURIComponent(`Check out Today's Park! ${referralLink}`)}`}
                        class="share-btn text-cream inline-flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm transition-colors hover:bg-white/20"
                      >
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" />
                        </svg>
                        SMS
                      </a>

                      {/* Email */}
                      <a
                        href={`mailto:?subject=${encodeURIComponent("Join me on Today's Park!")}&body=${encodeURIComponent(`I've been using Today's Park to discover local parks. Check it out: ${referralLink}`)}`}
                        class="share-btn text-cream inline-flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm transition-colors hover:bg-white/20"
                      >
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" />
                        </svg>
                        Email
                      </a>

                      {/* WhatsApp */}
                      <a
                        href={`https://wa.me/?text=${encodeURIComponent(`Check out Today's Park! ${referralLink}`)}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="share-btn text-cream inline-flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm transition-colors hover:bg-white/20"
                      >
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" />
                        </svg>
                        WhatsApp
                      </a>

                      {/* Twitter/X */}
                      <a
                        href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(`Discover your next park adventure with Today's Park!`)}&url=${encodeURIComponent(referralLink)}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="share-btn text-cream inline-flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm transition-colors hover:bg-white/20"
                      >
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
                        </svg>
                        X
                      </a>
                    </div>
                  </div>

                  {/* Referral Stats */}
                  {referralStats &&
                    (referralStats.totalReferrals > 0 || referralStats.activeBonusDaysUntil) && (
                      <div class="border-t border-white/10 pt-4">
                        <p class="text-mist mb-3 text-sm">Your referral stats</p>
                        <div class="grid grid-cols-3 gap-3">
                          <div class="rounded-lg bg-white/5 p-3 text-center">
                            <p class="text-cream text-xl font-semibold">{referralStats.pending}</p>
                            <p class="text-mist text-xs">Pending</p>
                          </div>
                          <div class="rounded-lg bg-white/5 p-3 text-center">
                            <p class="text-cream text-xl font-semibold">
                              {referralStats.converted}
                            </p>
                            <p class="text-mist text-xs">Converted</p>
                          </div>
                          <div class="rounded-lg bg-white/5 p-3 text-center">
                            <p class="text-gold text-xl font-semibold">
                              {referralStats.totalRewardsEarned}
                            </p>
                            <p class="text-mist text-xs">Rewards</p>
                          </div>
                        </div>
                        {referralStats.activeBonusDaysUntil && (
                          <p class="text-gold mt-3 text-sm">
                            ‚≠ê Bonus premium active until{" "}
                            {new Date(referralStats.activeBonusDaysUntil).toLocaleDateString(
                              "en-US",
                              { month: "short", day: "numeric", year: "numeric" }
                            )}
                          </p>
                        )}
                      </div>
                    )}

                  <p class="text-mist/70 text-xs">
                    Earn a free month of premium for each friend who subscribes!
                  </p>
                </div>
              ) : (
                <div class="space-y-4">
                  <p class="text-mist">Share Today's Park with friends and earn rewards!</p>
                  <Button id="generate-code-btn" variant="secondary" class="w-full">
                    Generate My Referral Link
                  </Button>
                </div>
              )
            }
          </CardContent>
        </Card>

        <!-- Account Settings via Clerk -->
        <Card class="border-white/15 bg-white/10 backdrop-blur-xl">
          <CardContent class="p-6">
            <h2 class="text-cream mb-4 font-[Fraunces] text-xl font-semibold">Account Settings</h2>
            <div class="user-profile-wrapper">
              <UserProfile />
            </div>
          </CardContent>
        </Card>
      </main>

      <footer class="mt-8 border-t border-white/10 pt-4">
        <nav class="text-mist flex justify-center gap-6 text-sm">
          <a href="/" class="hover:text-cream transition-colors">Home</a>
          <a href="/manage" class="hover:text-cream transition-colors">Manage Parks</a>
          <a href="/pricing" class="hover:text-cream transition-colors">Pricing</a>
          <a href="/help" class="hover:text-cream transition-colors">Help</a>
        </nav>
      </footer>
    </div>

    <style>
      /* Style overrides for Clerk UserProfile to match app theme */
      .user-profile-wrapper {
        --clerk-surface-background: transparent;
        --clerk-elements-card-background: rgba(255, 255, 255, 0.05);
      }

      .user-profile-wrapper :global(.cl-userProfile-root) {
        background: transparent;
        width: 100%;
      }

      .user-profile-wrapper :global(.cl-card) {
        background: transparent;
        box-shadow: none;
      }

      .user-profile-wrapper :global(.cl-navbar) {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 0.75rem;
      }

      .user-profile-wrapper :global(.cl-pageScrollBox) {
        padding: 0;
      }
    </style>

    <script>
      // Copy to clipboard functionality
      const copyBtn = document.getElementById("copy-link-btn");
      if (copyBtn) {
        copyBtn.addEventListener("click", async () => {
          const link = copyBtn.dataset.link;
          if (!link) return;

          try {
            await navigator.clipboard.writeText(link);
            const copyText = copyBtn.querySelector(".copy-text");
            const copiedText = copyBtn.querySelector(".copied-text");
            if (copyText && copiedText) {
              copyText.classList.add("hidden");
              copiedText.classList.remove("hidden");
              setTimeout(() => {
                copyText.classList.remove("hidden");
                copiedText.classList.add("hidden");
              }, 2000);
            }
          } catch (err) {
            console.error("Failed to copy:", err);
          }
        });
      }

      // Native share API (mobile)
      const nativeShareBtn = document.getElementById("native-share-btn");
      if (nativeShareBtn && navigator.share) {
        nativeShareBtn.classList.remove("hidden");
        nativeShareBtn.addEventListener("click", async () => {
          const link = nativeShareBtn.dataset.link;
          const title = nativeShareBtn.dataset.title;
          const text = nativeShareBtn.dataset.text;

          try {
            await navigator.share({
              title: title || "Today's Park",
              text: text || "Check out Today's Park!",
              url: link,
            });
          } catch (err) {
            if ((err as Error).name !== "AbortError") {
              console.error("Share failed:", err);
            }
          }
        });
      }

      // Generate referral code button
      const generateBtn = document.getElementById("generate-code-btn");
      if (generateBtn) {
        generateBtn.addEventListener("click", async () => {
          generateBtn.setAttribute("disabled", "true");
          generateBtn.textContent = "Generating...";

          try {
            const response = await fetch("/api/generate-referral-code", {
              method: "POST",
              credentials: "include",
            });

            if (response.ok) {
              // Reload page to show the new code
              window.location.reload();
            } else {
              throw new Error("Failed to generate code");
            }
          } catch (err) {
            console.error("Failed to generate referral code:", err);
            generateBtn.removeAttribute("disabled");
            generateBtn.textContent = "Generate My Referral Link";
            alert("Failed to generate referral code. Please try again.");
          }
        });
      }
    </script>
  </body>
</html>
