---
import { getConvexUrl, getUserParks, getAvailableParks, getUserEntitlements, type UserEntitlements } from "../lib/convexClient";
import { UserButton } from "@clerk/astro/components";
import "../styles/starwind.css";
import "../styles/global.css";
import Button from "../components/starwind/button/Button.astro";

// Auth check
const { userId, getToken } = Astro.locals.auth();
if (!userId) {
  return Astro.redirect("/sign-in");
}

const token = await getToken({ template: "convex" });
const convexUrl = getConvexUrl();

// Fetch parks and entitlements server-side
const [userParks, availableParks, entitlements] = await Promise.all([
  getUserParks(token!),
  getAvailableParks(token!),
  getUserEntitlements(token!).catch(() => null),
]);

// Calculate limits for display
const isFreeUser = entitlements?.tier === "free";
const maxParks = entitlements?.limits.maxParks ?? -1;
const currentParkCount = (userParks as any[]).length;
const canAddPark = entitlements?.canAddPark ?? true;
const isAtLimit = !canAddPark && isFreeUser;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Manage Parks</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=Source+Sans+3:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <div class="flex justify-between items-start mb-2">
          <div>
            <a href="/" class="text-gold text-sm font-medium hover:text-cream transition-colors mb-1 inline-block">&larr; Back</a>
            <h1 class="title">Manage Parks</h1>
            <p class="subtitle">Add or remove parks from your list</p>
          </div>
          <div class="mt-1">
            <UserButton afterSignOutUrl="/sign-in">
              <UserButton.MenuItems>
                <UserButton.Link label="Manage Parks" href="/manage">
                  <svg
                    slot="label-icon"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                    width="16"
                    height="16"
                  >
                    <path d="M12 2L6 10h3v4H6l6 8 6-8h-3v-4h3L12 2z" />
                  </svg>
                </UserButton.Link>
              </UserButton.MenuItems>
            </UserButton>
          </div>
        </div>

        {/* Park limit badge for free users */}
        {isFreeUser && maxParks > 0 && (
          <div class="mt-2 flex justify-center">
            <span class={`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-sm font-medium ${
              canAddPark
                ? "bg-forest/20 text-cream border border-forest/30"
                : "bg-sunset/20 text-sunset border border-sunset/30"
            }`}>
              {canAddPark ? (
                <>
                  <span>üå≤</span>
                  <span>{currentParkCount}/{maxParks} parks</span>
                </>
              ) : (
                <>
                  <span>‚ö†Ô∏è</span>
                  <span>Park limit reached ({maxParks}/{maxParks})</span>
                </>
              )}
            </span>
          </div>
        )}
      </header>

      {/* Upgrade prompt when limit reached */}
      {isAtLimit && (
        <div id="limit-banner" class="bg-gradient-to-r from-sunset/20 to-gold/20 border border-sunset/30 rounded-2xl p-4 mb-4 text-center">
          <p class="text-cream font-medium mb-2">You've reached your park limit!</p>
          <p class="text-mist text-sm mb-3">Free accounts can save up to {maxParks} parks. Upgrade to Premium for unlimited parks.</p>
          <a
            href="/pricing"
            class="inline-flex items-center gap-2 bg-gold text-forest font-semibold px-4 py-2 rounded-full hover:bg-cream transition-colors"
          >
            <span>‚≠ê</span>
            <span>Upgrade to Premium</span>
          </a>
        </div>
      )}

      <main class="space-y-8 !block">
        <!-- My Parks Section -->
        <section>
          <h2 class="font-[Fraunces] text-xl text-cream mb-4">
            My Parks ({currentParkCount}{isFreeUser && maxParks > 0 ? `/${maxParks}` : ""})
          </h2>

          {userParks.length === 0 ? (
            <div class="bg-white/10 backdrop-blur-xl rounded-2xl p-6 text-center border border-white/15">
              <p class="text-mist">No parks yet. Add some below to get started.</p>
            </div>
          ) : (
            <div class="grid gap-3">
              {userParks.map((park: any) => (
                <article
                  class="park-card bg-cream rounded-xl p-4 flex justify-between items-center gap-4 transition-opacity duration-200"
                  data-park-id={park.parkId}
                >
                  <div class="min-w-0 flex-1">
                    <h3 class="font-[Fraunces] text-forest font-semibold truncate">{park.name}</h3>
                    {park.customName && <p class="text-sm text-sunset truncate">{park.customName}</p>}
                    {park.address && <p class="text-sm text-moss truncate">{park.address}</p>}
                    {park.visitCount > 0 && (
                      <span class="inline-block mt-1 text-xs bg-gold/20 text-forest px-2 py-0.5 rounded-full">
                        {park.visitCount} visit{park.visitCount !== 1 ? 's' : ''}
                      </span>
                    )}
                  </div>
                  <button
                    class="remove-btn shrink-0 w-11 h-11 flex items-center justify-center rounded-full bg-sunset/10 hover:bg-sunset/20 text-sunset transition-colors"
                    data-remove={park.parkId}
                    aria-label={`Remove ${park.name}`}
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                </article>
              ))}
            </div>
          )}
        </section>

        <!-- Available Parks Section -->
        <section>
          <h2 class="font-[Fraunces] text-xl text-cream mb-4">Add Parks ({availableParks.length})</h2>

          {availableParks.length === 0 ? (
            <div class="bg-white/10 backdrop-blur-xl rounded-2xl p-6 text-center border border-white/15">
              <p class="text-mist">You've added all available parks!</p>
            </div>
          ) : (
            <div class="grid gap-3">
              {availableParks.map((park: any) => (
                <article
                  class="park-card bg-white/10 backdrop-blur-xl rounded-xl p-4 flex justify-between items-center gap-4 border border-white/15 transition-opacity duration-200"
                  data-available-id={park._id}
                >
                  <div class="min-w-0 flex-1">
                    <h3 class="font-[Fraunces] text-cream font-semibold truncate">{park.name}</h3>
                    {park.customName && <p class="text-sm text-gold truncate">{park.customName}</p>}
                    {park.address && <p class="text-sm text-mist truncate">{park.address}</p>}
                  </div>
                  <button
                    class={`add-btn shrink-0 w-11 h-11 flex items-center justify-center rounded-full transition-colors ${
                      isAtLimit
                        ? "bg-mist/10 text-mist/50 cursor-not-allowed"
                        : "bg-gold/20 hover:bg-gold/30 text-gold"
                    }`}
                    data-add={park._id}
                    aria-label={`Add ${park.name}`}
                    disabled={isAtLimit}
                  >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                  </button>
                </article>
              ))}
            </div>
          )}
        </section>
      </main>

      <footer class="mt-8 text-center space-y-2">
        <p class="text-sm text-mist opacity-80">
          <a href="/discover" class="text-gold font-semibold hover:text-cream transition-colors">Discover nearby parks &rarr;</a>
        </p>
        <p class="text-sm text-mist opacity-80">
          <a href="/" class="text-gold font-semibold hover:text-cream transition-colors">Pick a park &rarr;</a>
        </p>
        <nav class="flex justify-center gap-6 text-sm text-mist mt-4 pt-4 border-t border-white/10">
          <a href="/about" class="hover:text-cream transition-colors">About</a>
          <a href="/help" class="hover:text-cream transition-colors">Help</a>
          <a href="/legal/terms" class="hover:text-cream transition-colors">Terms</a>
          <a href="/legal/privacy" class="hover:text-cream transition-colors">Privacy</a>
        </nav>
      </footer>
    </div>

    <script define:vars={{ convexUrl, convexToken: token, isAtLimit, isFreeUser, maxParks }}>
      // Track current park count for dynamic limit checking
      let currentCount = document.querySelectorAll('section:first-of-type .park-card').length;

      // Helper to check if error is a limit error
      function isLimitError(errorMessage) {
        return errorMessage.includes("PARK_LIMIT_EXCEEDED") ||
               errorMessage.includes("park limit") ||
               errorMessage.includes("Maximum parks");
      }

      // Helper to update section counts
      function updateCounts() {
        const myParksSection = document.querySelector('section:first-of-type');
        const addParksSection = document.querySelector('section:last-of-type');

        const myParksCount = myParksSection?.querySelectorAll('.park-card').length || 0;
        const addParksCount = addParksSection?.querySelectorAll('.park-card').length || 0;

        currentCount = myParksCount;

        const myParksHeader = myParksSection?.querySelector('h2');
        const addParksHeader = addParksSection?.querySelector('h2');

        if (myParksHeader) {
          myParksHeader.textContent = isFreeUser && maxParks > 0
            ? `My Parks (${myParksCount}/${maxParks})`
            : `My Parks (${myParksCount})`;
        }
        if (addParksHeader) addParksHeader.textContent = `Add Parks (${addParksCount})`;

        // Check if at limit and disable add buttons
        if (isFreeUser && maxParks > 0 && myParksCount >= maxParks) {
          document.querySelectorAll('.add-btn').forEach(btn => {
            btn.disabled = true;
            btn.classList.remove('bg-gold/20', 'hover:bg-gold/30', 'text-gold');
            btn.classList.add('bg-mist/10', 'text-mist/50', 'cursor-not-allowed');
          });
        }
      }

      // Show limit error UI
      function showLimitError() {
        // Show a toast or banner
        const existingBanner = document.getElementById('limit-banner');
        if (!existingBanner) {
          const banner = document.createElement('div');
          banner.id = 'limit-banner';
          banner.className = 'bg-gradient-to-r from-sunset/20 to-gold/20 border border-sunset/30 rounded-2xl p-4 mb-4 text-center';
          banner.innerHTML = `
            <p class="text-cream font-medium mb-2">You've reached your park limit!</p>
            <p class="text-mist text-sm mb-3">Free accounts can save up to ${maxParks} parks. Upgrade to Premium for unlimited parks.</p>
            <a
              href="/pricing"
              class="inline-flex items-center gap-2 bg-gold text-forest font-semibold px-4 py-2 rounded-full hover:bg-cream transition-colors"
            >
              <span>‚≠ê</span>
              <span>Upgrade to Premium</span>
            </a>
          `;
          const main = document.querySelector('main');
          main.parentNode.insertBefore(banner, main);
        }
      }

      // Handle add park with optimistic UI
      document.querySelectorAll('.add-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const button = e.currentTarget;
          const parkId = button.dataset.add;
          const card = button.closest('.park-card');

          // Prevent action if already at limit
          if (button.disabled) return;

          button.disabled = true;
          button.innerHTML = '<span class="w-4 h-4 border-2 border-gold border-t-transparent rounded-full animate-spin"></span>';

          try {
            const response = await fetch(`${convexUrl}/api/mutation`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${convexToken}`
              },
              body: JSON.stringify({
                path: 'userParks:addParkToUserList',
                args: { parkId },
                format: 'json'
              })
            });

            const result = await response.json();

            if (result.status === 'error') {
              throw new Error(result.errorMessage || 'Failed to add park');
            }

            // Optimistic UI: fade out and remove card
            card.style.opacity = '0';
            card.style.transform = 'translateX(20px)';
            setTimeout(() => {
              card.remove();
              updateCounts();
            }, 200);
          } catch (err) {
            console.error('Failed to add park:', err);

            // Check if this is a limit error
            if (isLimitError(err.message)) {
              showLimitError();
              updateCounts(); // Will disable all add buttons
            } else {
              button.disabled = false;
              button.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>';
            }
          }
        });
      });

      // Handle remove park with optimistic UI
      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const button = e.currentTarget;
          const parkId = button.dataset.remove;
          const card = button.closest('.park-card');

          button.disabled = true;
          button.innerHTML = '<span class="w-4 h-4 border-2 border-sunset border-t-transparent rounded-full animate-spin"></span>';

          try {
            await fetch(`${convexUrl}/api/mutation`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${convexToken}`
              },
              body: JSON.stringify({
                path: 'userParks:removeParkFromUserList',
                args: { parkId },
                format: 'json'
              })
            });

            // Optimistic UI: fade out and remove card
            card.style.opacity = '0';
            card.style.transform = 'translateX(-20px)';
            setTimeout(() => {
              card.remove();
              updateCounts();
            }, 200);
          } catch (err) {
            console.error('Failed to remove park:', err);
            button.disabled = false;
            button.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>';
          }
        });
      });
    </script>
  </body>
</html>
