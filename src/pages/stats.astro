---
import { getUserParkStats } from "../lib/convexClient";
import { UserButton } from "@clerk/astro/components";
import "../styles/starwind.css";
import "../styles/global.css";
import SEO from "../components/SEO.astro";
import JsonLd from "../components/JsonLd.astro";
import { createItemListSchema, createBreadcrumbSchema } from "../lib/schemas";
import { SITE_URL, SITE_NAME } from "../lib/config";
import Card from "../components/starwind/card/Card.astro";
import CardContent from "../components/starwind/card/CardContent.astro";
import Badge from "../components/starwind/badge/Badge.astro";
import Table from "../components/starwind/table/Table.astro";
import TableBody from "../components/starwind/table/TableBody.astro";
import TableCell from "../components/starwind/table/TableCell.astro";
import TableHead from "../components/starwind/table/TableHead.astro";
import TableHeader from "../components/starwind/table/TableHeader.astro";
import TableRow from "../components/starwind/table/TableRow.astro";

// Get Clerk auth
const { userId, getToken } = Astro.locals.auth();

// Redirect to sign-in if not authenticated
if (!userId) {
  return Astro.redirect("/sign-in");
}

const convexToken = await getToken({ template: "convex" });

let parks: Awaited<ReturnType<typeof getUserParkStats>> = [];
let error: string | null = null;

try {
  if (!convexToken) {
    throw new Error("Unable to get authentication token");
  }
  const rawParks = await getUserParkStats(convexToken);
  // Already sorted by visit count from backend, but sort alphabetically as secondary
  parks = rawParks.sort((a, b) => {
    const visitsA = a.visitCount ?? 0;
    const visitsB = b.visitCount ?? 0;
    if (visitsB !== visitsA) return visitsB - visitsA;
    return a.name.localeCompare(b.name);
  });
} catch (e) {
  error = e instanceof Error ? e.message : "Failed to load stats";
  console.error("Error loading stats:", e);
}

const totalVisits = parks.reduce((sum, park) => sum + (park.visitCount ?? 0), 0);

// Schema data for SEO
const breadcrumbs = [
  { name: "Home", url: SITE_URL },
  { name: "Stats", url: `${SITE_URL}/stats` },
];

const itemListData = parks.map((park, index) => ({
  name: park.name,
  position: index + 1,
}));
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <SEO
      title={`Your Park Stats - ${SITE_NAME}`}
      description={`Track your park visit history and see which parks you've explored most. View statistics for all the parks in your ${SITE_NAME} list.`}
      noindex={true}
    >
      <JsonLd schema={createBreadcrumbSchema(breadcrumbs)} />
      {
        parks.length > 0 && (
          <JsonLd schema={createItemListSchema(itemListData, "Your Park Visit Stats")} />
        )
      }
    </SEO>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=Source+Sans+3:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <div class="mb-2 flex items-start justify-between">
          <div>
            <h1 class="title">Your Park Stats</h1>
            <p class="subtitle">Track your park visits and adventures</p>
          </div>
          <div class="mt-1">
            <UserButton afterSignOutUrl="/sign-in" />
          </div>
        </div>
      </header>

      <main class="flex flex-1 flex-col">
        <!-- Navigation header -->
        <Card class="mb-4 border-white/15 bg-white/10 backdrop-blur-xl">
          <CardContent class="flex items-center justify-between p-4">
            <a
              href="/"
              class="text-gold hover:text-cream text-[0.9375rem] font-semibold transition-colors"
              >‚Üê Back to {SITE_NAME}</a
            >
            <Badge variant="outline" class="text-mist border-none bg-white/10"
              >{totalVisits} visits</Badge
            >
          </CardContent>
        </Card>

        {
          error ? (
            <Card class="border-white/15 bg-white/10 backdrop-blur-xl">
              <CardContent class="p-10 text-center">
                <div class="mb-4 text-4xl">‚ö†Ô∏è</div>
                <p class="text-cream text-lg font-medium">{error}</p>
              </CardContent>
            </Card>
          ) : parks.length === 0 ? (
            <Card class="border-white/15 bg-white/10 backdrop-blur-xl">
              <CardContent class="px-8 py-12 text-center">
                <div class="mb-4 text-4xl">üå≤</div>
                <p class="text-mist">No parks in your list yet. Pick some parks to get started!</p>
              </CardContent>
            </Card>
          ) : (
            <Card class="overflow-hidden">
              <h2 class="sr-only">Your Park Visit History</h2>
              <Table class="table-fixed">
                <TableHeader>
                  <TableRow class="bg-mist/30 border-sage/30 border-b">
                    <TableHead class="text-forest px-3 py-3 text-sm font-semibold">Park</TableHead>
                    <TableHead class="text-forest w-14 px-2 py-3 text-center text-sm font-semibold">
                      Visits
                    </TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {parks.map((park, index) => {
                    const hasVisits = (park.visitCount ?? 0) > 0;
                    return (
                      <TableRow
                        class={`border-sage/20 animate-card-appear border-b transition-colors ${hasVisits ? "bg-gold/5" : ""}`}
                        style={`animation-delay: ${index * 0.03}s`}
                      >
                        <TableCell class="px-3 py-3">
                          <div class="text-forest truncate font-[Fraunces] text-[0.9375rem] leading-tight font-semibold">
                            {park.name}
                          </div>
                          {park.address && (
                            <div class="text-moss mt-0.5 truncate text-xs">{park.address}</div>
                          )}
                        </TableCell>
                        <TableCell class="w-14 px-2 py-3 text-center align-top">
                          <div class="flex flex-col items-center">
                            <span
                              class={`font-[Fraunces] text-lg font-bold ${hasVisits ? "text-sunset" : "text-sage"}`}
                            >
                              {park.visitCount ?? 0}
                            </span>
                            <span class="text-sage text-[0.5625rem] tracking-wide uppercase">
                              visits
                            </span>
                          </div>
                        </TableCell>
                      </TableRow>
                    );
                  })}
                </TableBody>
              </Table>
            </Card>
          )
        }
      </main>

      <footer class="mt-8 text-center">
        <p class="text-mist text-sm opacity-80">
          Stats update each time you open a park in Google Maps.
        </p>
        <nav class="text-mist mt-4 flex justify-center gap-6 border-t border-white/10 pt-4 text-sm">
          <a href="/about" class="hover:text-cream transition-colors">About</a>
          <a href="/help" class="hover:text-cream transition-colors">Help</a>
          <a href="/legal/terms" class="hover:text-cream transition-colors">Terms</a>
          <a href="/legal/privacy" class="hover:text-cream transition-colors">Privacy</a>
        </nav>
      </footer>
    </div>
  </body>
</html>
