---
import { getParkStats } from "../lib/convexClient";
import "../styles/starwind.css";
import "../styles/global.css";
import Card from "../components/starwind/card/Card.astro";
import CardContent from "../components/starwind/card/CardContent.astro";
import Badge from "../components/starwind/badge/Badge.astro";
import Table from "../components/starwind/table/Table.astro";
import TableBody from "../components/starwind/table/TableBody.astro";
import TableCell from "../components/starwind/table/TableCell.astro";
import TableHead from "../components/starwind/table/TableHead.astro";
import TableHeader from "../components/starwind/table/TableHeader.astro";
import TableRow from "../components/starwind/table/TableRow.astro";
import Separator from "../components/starwind/separator/Separator.astro";

let parks: Awaited<ReturnType<typeof getParkStats>> = [];
let error: string | null = null;

try {
  const rawParks = await getParkStats();
  // Sort by visit count (highest first), then alphabetically by name
  parks = rawParks.sort((a, b) => {
    const visitsA = a.visitCount ?? 0;
    const visitsB = b.visitCount ?? 0;
    if (visitsB !== visitsA) return visitsB - visitsA;
    return a.name.localeCompare(b.name);
  });
} catch (e) {
  error = e instanceof Error ? e.message : "Failed to load stats";
  console.error("Error loading stats:", e);
}

const totalVisits = parks.reduce(
  (sum, park) => sum + (park.visitCount ?? 0),
  0
);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Park Stats</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=Source+Sans+3:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <h1 class="title">Park Stats</h1>
        <p class="subtitle">Track your park adventures</p>
      </header>

      <main class="flex-1 flex flex-col">
        <!-- Navigation header -->
        <Card class="bg-white/10 backdrop-blur-xl border-white/15 mb-4">
          <CardContent class="flex justify-between items-center p-4">
            <a href="/" class="text-[0.9375rem] font-semibold text-gold hover:text-cream transition-colors">← Back to Today's Park</a>
            <Badge variant="outline" class="bg-white/10 text-mist border-none">{totalVisits} total visits</Badge>
          </CardContent>
        </Card>

        {
          error ? (
            <Card class="bg-white/10 backdrop-blur-xl border-white/15">
              <CardContent class="p-10 text-center">
                <div class="text-4xl mb-4">⚠️</div>
                <p class="text-lg text-cream font-medium">{error}</p>
              </CardContent>
            </Card>
          ) : parks.length === 0 ? (
            <Card class="bg-white/10 backdrop-blur-xl border-white/15">
              <CardContent class="py-12 px-8 text-center">
                <p class="text-mist">No parks found. Visit some parks to see stats!</p>
              </CardContent>
            </Card>
          ) : (
            <Card class="overflow-hidden">
              <Table class="table-fixed">
                <TableHeader>
                  <TableRow class="bg-mist/30 border-b border-sage/30">
                    <TableHead class="text-forest font-semibold text-sm py-3 px-3">Park</TableHead>
                    <TableHead class="text-forest font-semibold text-sm py-3 px-2 text-center w-14">Visits</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {parks.map((park, index) => {
                    const hasVisits = (park.visitCount ?? 0) > 0;
                    return (
                      <TableRow
                        class={`border-b border-sage/20 transition-colors animate-card-appear ${hasVisits ? 'bg-gold/5' : ''}`}
                        style={`animation-delay: ${index * 0.03}s`}
                      >
                        <TableCell class="py-3 px-3">
                          <div class="font-[Fraunces] font-semibold text-forest text-[0.9375rem] leading-tight truncate">
                            {park.name}
                          </div>
                          {park.address && (
                            <div class="text-xs text-moss mt-0.5 truncate">
                              {park.address}
                            </div>
                          )}
                        </TableCell>
                        <TableCell class="text-center align-top py-3 px-2 w-14">
                          <div class="flex flex-col items-center">
                            <span class={`font-[Fraunces] text-lg font-bold ${hasVisits ? 'text-sunset' : 'text-sage'}`}>
                              {park.visitCount ?? 0}
                            </span>
                            <span class="text-[0.5625rem] text-sage uppercase tracking-wide">
                              visits
                            </span>
                          </div>
                        </TableCell>
                      </TableRow>
                    );
                  })}
                </TableBody>
              </Table>
            </Card>
          )
        }
      </main>

      <footer class="mt-8 text-center">
        <p class="text-sm text-mist opacity-80">Stats update each time you open a park in Google Maps.</p>
      </footer>
    </div>
  </body>
</html>
