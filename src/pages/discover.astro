---
import { getConvexUrl, getAvailableParks } from "../lib/convexClient";
import { UserButton } from "@clerk/astro/components";
import "../styles/starwind.css";
import "../styles/global.css";

// Auth check
const { userId, getToken } = Astro.locals.auth();
if (!userId) {
  return Astro.redirect("/sign-in");
}

const token = await getToken({ template: "convex" });
const convexUrl = getConvexUrl();

// Pre-fetch available parks for fallback (Sarasota recommended)
const availableParks = await getAvailableParks(token!);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Discover Parks</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=Source+Sans+3:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <div class="flex justify-between items-start mb-2">
          <div>
            <a href="/manage" class="text-gold text-sm font-medium hover:text-cream transition-colors mb-1 inline-block">&larr; Back to Manage</a>
            <h1 class="title">Discover Parks</h1>
            <p class="subtitle">Find parks near your location</p>
          </div>
          <div class="mt-1">
            <UserButton afterSignOutUrl="/sign-in">
              <UserButton.MenuItems>
                <UserButton.Link label="Manage Parks" href="/manage">
                  <svg
                    slot="label-icon"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                    width="16"
                    height="16"
                  >
                    <path d="M12 2L6 10h3v4H6l6 8 6-8h-3v-4h3L12 2z" />
                  </svg>
                </UserButton.Link>
              </UserButton.MenuItems>
            </UserButton>
          </div>
        </div>
      </header>

      <main class="space-y-6 !block">
        <!-- Location Status Banner -->
        <div id="location-banner" class="bg-white/10 backdrop-blur-xl rounded-2xl p-4 border border-white/15">
          <div id="location-requesting" class="flex items-center gap-3">
            <span class="w-5 h-5 border-2 border-gold border-t-transparent rounded-full animate-spin"></span>
            <span class="text-cream">Requesting your location...</span>
          </div>
          <div id="location-granted" class="hidden flex items-center gap-2 text-gold">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
            </svg>
            <span>Using your location</span>
          </div>
          <div id="location-denied" class="hidden">
            <div class="flex items-center gap-2 text-sunset mb-2">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm1 13h-2v-2h2v2zm0-4h-2V6h2v5z"/>
              </svg>
              <span>Location access denied</span>
            </div>
            <p class="text-mist text-sm">Showing recommended Sarasota parks instead.</p>
          </div>
          <div id="location-error" class="hidden">
            <div class="flex items-center gap-2 text-sunset mb-2">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
              </svg>
              <span id="error-message">Unable to get location</span>
            </div>
            <p class="text-mist text-sm">Showing recommended Sarasota parks instead.</p>
          </div>
        </div>

        <!-- Radius Selector (hidden until location granted) -->
        <div id="radius-selector" class="hidden flex items-center gap-3">
          <span class="text-mist text-sm">Search radius:</span>
          <div class="flex gap-2">
            <button
              id="radius-5"
              class="radius-btn px-4 py-2 rounded-full text-sm font-medium transition-colors bg-gold text-forest"
              data-radius="5"
            >
              5 mi
            </button>
            <button
              id="radius-10"
              class="radius-btn px-4 py-2 rounded-full text-sm font-medium transition-colors bg-white/10 text-cream border border-white/20 hover:bg-white/20"
              data-radius="10"
            >
              10 mi
            </button>
          </div>
          <button
            id="refresh-btn"
            class="ml-auto p-2 rounded-full bg-white/10 text-cream hover:bg-white/20 transition-colors"
            title="Refresh"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
          </button>
        </div>

        <!-- Loading State -->
        <div id="parks-loading" class="hidden text-center py-8">
          <span class="w-8 h-8 border-3 border-gold border-t-transparent rounded-full animate-spin inline-block"></span>
          <p class="text-mist mt-3">Searching for nearby parks...</p>
        </div>

        <!-- Parks List (Nearby) -->
        <section id="nearby-parks-section" class="hidden">
          <h2 class="font-[Fraunces] text-xl text-cream mb-4">
            Nearby Parks (<span id="nearby-count">0</span>)
          </h2>
          <div id="nearby-parks-list" class="grid gap-3">
            <!-- Populated by JavaScript -->
          </div>
          <div id="nearby-empty" class="hidden bg-white/10 backdrop-blur-xl rounded-2xl p-6 text-center border border-white/15">
            <p class="text-mist">No parks found nearby. Try increasing the search radius.</p>
          </div>
        </section>

        <!-- Fallback Section (Sarasota Recommended) -->
        <section id="fallback-section" class="hidden">
          <div class="flex items-center gap-3 mb-4">
            <div class="h-px bg-white/20 flex-1"></div>
            <span class="text-mist text-sm">Sarasota Recommended</span>
            <div class="h-px bg-white/20 flex-1"></div>
          </div>
          <div id="fallback-parks-list" class="grid gap-3">
            {availableParks.slice(0, 10).map((park: any) => (
              <article
                class="park-card bg-white/10 backdrop-blur-xl rounded-xl p-4 flex justify-between items-center gap-4 border border-white/15 transition-opacity duration-200"
                data-available-id={park._id}
              >
                <div class="min-w-0 flex-1">
                  <h3 class="font-[Fraunces] text-cream font-semibold truncate">{park.name}</h3>
                  {park.customName && <p class="text-sm text-gold truncate">{park.customName}</p>}
                  {park.address && <p class="text-sm text-mist truncate">{park.address}</p>}
                </div>
                <button
                  class="add-btn shrink-0 w-11 h-11 flex items-center justify-center rounded-full bg-gold/20 hover:bg-gold/30 text-gold transition-colors"
                  data-add={park._id}
                  aria-label={`Add ${park.name}`}
                >
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  </svg>
                </button>
              </article>
            ))}
          </div>
        </section>
      </main>

      <footer class="mt-8 text-center">
        <p class="text-sm text-mist opacity-80">
          <a href="/manage" class="text-gold font-semibold hover:text-cream transition-colors">Manage your parks &rarr;</a>
        </p>
        <nav class="flex justify-center gap-6 text-sm text-mist mt-4 pt-4 border-t border-white/10">
          <a href="/about" class="hover:text-cream transition-colors">About</a>
          <a href="/help" class="hover:text-cream transition-colors">Help</a>
          <a href="/legal/terms" class="hover:text-cream transition-colors">Terms</a>
          <a href="/legal/privacy" class="hover:text-cream transition-colors">Privacy</a>
        </nav>
      </footer>
    </div>

    <script define:vars={{ convexUrl, convexToken: token }}>
      // State
      let currentRadius = 5;
      let userLat = null;
      let userLng = null;

      // DOM elements
      const locationBanner = document.getElementById('location-banner');
      const locationRequesting = document.getElementById('location-requesting');
      const locationGranted = document.getElementById('location-granted');
      const locationDenied = document.getElementById('location-denied');
      const locationError = document.getElementById('location-error');
      const errorMessage = document.getElementById('error-message');
      const radiusSelector = document.getElementById('radius-selector');
      const parksLoading = document.getElementById('parks-loading');
      const nearbyParksSection = document.getElementById('nearby-parks-section');
      const nearbyParksList = document.getElementById('nearby-parks-list');
      const nearbyCount = document.getElementById('nearby-count');
      const nearbyEmpty = document.getElementById('nearby-empty');
      const fallbackSection = document.getElementById('fallback-section');

      // Request geolocation on load
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLat = position.coords.latitude;
            userLng = position.coords.longitude;
            showLocationGranted();
            fetchNearbyParks();
          },
          (error) => {
            console.error('Geolocation error:', error);
            if (error.code === error.PERMISSION_DENIED) {
              showLocationDenied();
            } else {
              showLocationError(error.message || 'Unable to get location');
            }
            showFallbackParks();
          },
          { enableHighAccuracy: false, timeout: 10000 }
        );
      } else {
        showLocationError('Geolocation not supported');
        showFallbackParks();
      }

      function showLocationGranted() {
        locationRequesting.classList.add('hidden');
        locationGranted.classList.remove('hidden');
        radiusSelector.classList.remove('hidden');
      }

      function showLocationDenied() {
        locationRequesting.classList.add('hidden');
        locationDenied.classList.remove('hidden');
      }

      function showLocationError(msg) {
        locationRequesting.classList.add('hidden');
        errorMessage.textContent = msg;
        locationError.classList.remove('hidden');
      }

      function showFallbackParks() {
        fallbackSection.classList.remove('hidden');
        setupFallbackAddButtons();
      }

      async function fetchNearbyParks() {
        parksLoading.classList.remove('hidden');
        nearbyParksSection.classList.add('hidden');

        try {
          const response = await fetch(`${convexUrl}/api/action`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${convexToken}`
            },
            body: JSON.stringify({
              path: 'actions/searchNearbyParks:searchNearbyParks',
              args: { lat: userLat, lng: userLng, radiusMiles: currentRadius },
              format: 'json'
            })
          });

          const result = await response.json();

          if (result.status === 'error') {
            throw new Error(result.errorMessage);
          }

          const parks = result.value || [];
          renderNearbyParks(parks);
        } catch (err) {
          console.error('Failed to fetch nearby parks:', err);
          nearbyEmpty.textContent = 'Failed to load nearby parks. Please try again.';
          nearbyEmpty.classList.remove('hidden');
          nearbyParksSection.classList.remove('hidden');
        } finally {
          parksLoading.classList.add('hidden');
        }
      }

      function renderNearbyParks(parks) {
        nearbyParksList.innerHTML = '';
        nearbyCount.textContent = parks.length;

        if (parks.length === 0) {
          nearbyEmpty.classList.remove('hidden');
          nearbyParksSection.classList.remove('hidden');
          return;
        }

        nearbyEmpty.classList.add('hidden');

        parks.forEach(park => {
          const article = document.createElement('article');
          article.className = 'park-card bg-white/10 backdrop-blur-xl rounded-xl p-4 flex gap-4 border border-white/15 transition-opacity duration-200';
          article.dataset.parkId = park._id;

          // Photo thumbnail (if available)
          const photoHtml = park.photoUrl
            ? `<img src="${park.photoUrl}" alt="" class="w-16 h-16 rounded-lg object-cover shrink-0" loading="lazy" />`
            : `<div class="w-16 h-16 rounded-lg bg-white/5 flex items-center justify-center shrink-0">
                 <svg class="w-8 h-8 text-mist/50" fill="currentColor" viewBox="0 0 24 24">
                   <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
                 </svg>
               </div>`;

          // Type badge
          const typeLabel = formatParkType(park.primaryType);
          const typeBadge = typeLabel
            ? `<span class="inline-block text-xs bg-white/10 text-mist px-2 py-0.5 rounded-full">${typeLabel}</span>`
            : '';

          // Already added indicator
          const isAdded = park.isInUserList;
          const actionButton = isAdded
            ? `<div class="shrink-0 w-11 h-11 flex items-center justify-center rounded-full bg-gold/10 text-gold/60">
                 <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                   <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                 </svg>
               </div>`
            : `<button
                 class="add-nearby-btn shrink-0 w-11 h-11 flex items-center justify-center rounded-full bg-gold/20 hover:bg-gold/30 text-gold transition-colors"
                 data-add-nearby="${park._id}"
                 aria-label="Add ${park.name}"
               >
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                 </svg>
               </button>`;

          article.innerHTML = `
            ${photoHtml}
            <div class="min-w-0 flex-1">
              <div class="flex items-start justify-between gap-2">
                <h3 class="font-[Fraunces] text-cream font-semibold truncate">${park.name}</h3>
                <span class="shrink-0 text-sm text-gold font-medium">${park.distanceMiles} mi</span>
              </div>
              ${park.address ? `<p class="text-sm text-mist truncate mt-0.5">${park.address}</p>` : ''}
              <div class="flex items-center gap-2 mt-2">
                ${typeBadge}
                ${isAdded ? '<span class="text-xs text-gold/70">In your list</span>' : ''}
              </div>
            </div>
            ${actionButton}
          `;

          nearbyParksList.appendChild(article);
        });

        nearbyParksSection.classList.remove('hidden');
        setupNearbyAddButtons();
      }

      function formatParkType(type) {
        if (!type) return '';
        const labels = {
          'park': 'Park',
          'playground': 'Playground',
          'dog_park': 'Dog Park'
        };
        return labels[type] || type.replace(/_/g, ' ');
      }

      function setupNearbyAddButtons() {
        document.querySelectorAll('.add-nearby-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const button = e.currentTarget;
            const parkId = button.dataset.addNearby;

            button.disabled = true;
            button.innerHTML = '<span class="w-4 h-4 border-2 border-gold border-t-transparent rounded-full animate-spin"></span>';

            try {
              await fetch(`${convexUrl}/api/mutation`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${convexToken}`
                },
                body: JSON.stringify({
                  path: 'userParks:addParkToUserList',
                  args: { parkId },
                  format: 'json'
                })
              });

              // Update UI to show added state
              button.outerHTML = `
                <div class="shrink-0 w-11 h-11 flex items-center justify-center rounded-full bg-gold/10 text-gold/60">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                  </svg>
                </div>
              `;

              // Add "In your list" text
              const card = document.querySelector(`[data-park-id="${parkId}"]`);
              if (card) {
                const badgeContainer = card.querySelector('.flex.items-center.gap-2.mt-2');
                if (badgeContainer && !badgeContainer.querySelector('.text-gold\\/70')) {
                  const addedSpan = document.createElement('span');
                  addedSpan.className = 'text-xs text-gold/70';
                  addedSpan.textContent = 'In your list';
                  badgeContainer.appendChild(addedSpan);
                }
              }
            } catch (err) {
              console.error('Failed to add park:', err);
              button.disabled = false;
              button.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>';
            }
          });
        });
      }

      function setupFallbackAddButtons() {
        document.querySelectorAll('#fallback-section .add-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const button = e.currentTarget;
            const parkId = button.dataset.add;

            button.disabled = true;
            button.innerHTML = '<span class="w-4 h-4 border-2 border-gold border-t-transparent rounded-full animate-spin"></span>';

            try {
              await fetch(`${convexUrl}/api/mutation`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${convexToken}`
                },
                body: JSON.stringify({
                  path: 'userParks:addParkToUserList',
                  args: { parkId },
                  format: 'json'
                })
              });

              // Fade out and remove the card
              const card = button.closest('.park-card');
              card.style.opacity = '0.5';
              button.innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
            } catch (err) {
              console.error('Failed to add park:', err);
              button.disabled = false;
              button.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>';
            }
          });
        });
      }

      // Radius selector handlers
      document.querySelectorAll('.radius-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const radius = parseInt(e.currentTarget.dataset.radius);
          if (radius === currentRadius) return;

          currentRadius = radius;

          // Update button styles
          document.querySelectorAll('.radius-btn').forEach(b => {
            if (parseInt(b.dataset.radius) === currentRadius) {
              b.className = 'radius-btn px-4 py-2 rounded-full text-sm font-medium transition-colors bg-gold text-forest';
            } else {
              b.className = 'radius-btn px-4 py-2 rounded-full text-sm font-medium transition-colors bg-white/10 text-cream border border-white/20 hover:bg-white/20';
            }
          });

          // Re-fetch parks
          if (userLat && userLng) {
            fetchNearbyParks();
          }
        });
      });

      // Refresh button handler
      document.getElementById('refresh-btn').addEventListener('click', () => {
        if (userLat && userLng) {
          fetchNearbyParks();
        }
      });
    </script>
  </body>
</html>
